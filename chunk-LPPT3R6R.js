import{a as H}from"./chunk-JEO34WBT.js";import{a as V,b as p,c as z,d as T,e as D,f as j,g as A,h as G,i as L,j as q,k as $,l as B,m as W,n as Y}from"./chunk-OWGPU7TU.js";import{a as J}from"./chunk-L5BCGA6N.js";import{$a as U,Ab as F,Cb as N,Ea as c,Eb as P,Ha as l,Ja as r,Ka as t,La as v,Ma as C,Na as u,Oa as m,S as h,Sa as o,Ta as x,Ua as _,Va as w,W as M,Wa as S,Xa as R,Ya as E,_a as I,ca as g,da as f,pa as y,ta as a,zb as k}from"./chunk-MMXZZOCS.js";var Q=()=>({standalone:!0});function X(s,n){if(s&1&&(r(0,"option",23),o(1),t()),s&2){let e=n.$implicit;l("ngValue",e.id),a(),w(" ",e.nombre," - ",e.cedula," ")}}function Z(s,n){s&1&&(r(0,"small"),o(1," No hay empleados disponibles para vincular. "),t())}function ee(s,n){s&1&&(r(0,"p"),o(1,"Cargando usuarios..."),t())}function te(s,n){if(s&1&&(r(0,"option",31),o(1),t()),s&2){let e=n.$implicit;l("value",e),a(),x(e)}}function re(s,n){if(s&1){let e=C();r(0,"tr")(1,"td"),o(2),t(),r(3,"td"),o(4),t(),r(5,"td")(6,"select",26),E("ngModelChange",function(d){let b=g(e).$implicit,O=m(2);return R(O.rolEditadoPorUsuario[b.id],d)||(O.rolEditadoPorUsuario[b.id]=d),f(d)}),c(7,te,2,2,"option",27),t()(),r(8,"td"),o(9),t(),r(10,"td",28)(11,"button",29),u("click",function(){let d=g(e).$implicit,b=m(2);return f(b.actualizarRol(d))}),o(12),t(),r(13,"button",30),u("click",function(){let d=g(e).$implicit,b=m(2);return f(b.abrirModalResetPassword(d))}),o(14),t()()()}if(s&2){let e=n.$implicit,i=m(2);a(2),x(e.nombre),a(2),x(e.email),a(2),S("ngModel",i.rolEditadoPorUsuario[e.id]),l("ngModelOptions",U(11,Q)),a(),l("ngForOf",i.rolesDisponibles),a(2),w("",e.empleado_nombre||"-"," ",e.empleado_cedula?"("+e.empleado_cedula+")":"",""),a(2),l("disabled",i.actualizandoRolId===e.id),a(),_(" ",i.actualizandoRolId===e.id?"Guardando rol...":"Guardar rol"," "),a(),l("disabled",i.reseteandoPasswordId===e.id),a(),_(" ",i.reseteandoPasswordId===e.id?"Reseteando...":"Reset password"," ")}}function oe(s,n){if(s&1&&(r(0,"div",24)(1,"table")(2,"thead")(3,"tr")(4,"th"),o(5,"Nombre"),t(),r(6,"th"),o(7,"Email"),t(),r(8,"th"),o(9,"Rol"),t(),r(10,"th"),o(11,"Empleado vinculado"),t(),r(12,"th"),o(13,"Acciones"),t()()(),r(14,"tbody"),c(15,re,15,12,"tr",25),t()()()),s&2){let e=m();a(15),l("ngForOf",e.usuarios)}}function ne(s,n){s&1&&(r(0,"p"),o(1,"No hay usuarios registrados."),t())}function ie(s,n){if(s&1&&(r(0,"span"),o(1),t()),s&2){let e=m(2);a(),_("(",e.usuarioResetObjetivo==null?null:e.usuarioResetObjetivo.email,")")}}function ae(s,n){s&1&&(r(0,"small",44),o(1," Debe tener minimo 6 caracteres. "),t())}function se(s,n){s&1&&(r(0,"small",44),o(1," Las contrasenas no coinciden. "),t())}function le(s,n){if(s&1){let e=C();r(0,"div",32)(1,"div",33)(2,"h4",34),o(3,"Resetear contrasena"),t(),r(4,"p",35),o(5," Usuario: "),r(6,"strong"),o(7),t(),c(8,ie,2,1,"span",10),t(),r(9,"form",36),u("ngSubmit",function(){g(e);let d=m();return f(d.confirmarResetPassword())}),r(10,"div",6)(11,"label"),o(12,"Nueva contrasena"),t(),r(13,"div",37),v(14,"input",38),r(15,"button",39),u("click",function(){g(e);let d=m();return f(d.toggleMostrarPasswordReset())}),o(16),t()(),c(17,ae,2,0,"small",40),t(),r(18,"div",6)(19,"label"),o(20,"Confirmar contrasena"),t(),r(21,"div",37),v(22,"input",41),r(23,"button",39),u("click",function(){g(e);let d=m();return f(d.toggleMostrarConfirmPasswordReset())}),o(24),t()(),c(25,se,2,0,"small",40),t(),r(26,"div",42)(27,"button",29),u("click",function(){g(e);let d=m();return f(d.cerrarModalResetPassword())}),o(28," Cancelar "),t(),r(29,"button",43),o(30),t()()()()()}if(s&2){let e=m();a(7),x(e.usuarioResetObjetivo==null?null:e.usuarioResetObjetivo.nombre),a(),l("ngIf",e.usuarioResetObjetivo==null?null:e.usuarioResetObjetivo.email),a(),l("formGroup",e.resetForm),a(5),l("type",e.mostrarPasswordReset?"text":"password"),a(),l("disabled",e.reseteandoPasswordId!==null),a(),_(" ",e.mostrarPasswordReset?"Ocultar":"Mostrar"," "),a(),l("ngIf",e.resetForm.controls.password.touched&&e.resetForm.controls.password.invalid),a(5),l("type",e.mostrarConfirmPasswordReset?"text":"password"),a(),l("disabled",e.reseteandoPasswordId!==null),a(),_(" ",e.mostrarConfirmPasswordReset?"Ocultar":"Mostrar"," "),a(),l("ngIf",e.passwordsNoCoinciden),a(2),l("disabled",e.reseteandoPasswordId!==null),a(2),l("disabled",e.reseteandoPasswordId!==null),a(),_(" ",e.reseteandoPasswordId!==null?"Reseteando...":"Confirmar reset"," ")}}var K=class s{fb=h(B);usuariosService=h(J);toast=h(H);platformId=h(y);loading=!0;guardando=!1;actualizandoRolId=null;reseteandoPasswordId=null;empleados=[];usuarios=[];rolesDisponibles=["admin","gerente","rrhh","operador_patio","operador"];rolEditadoPorUsuario={};modalResetAbierto=!1;usuarioResetObjetivo=null;mostrarPasswordReset=!1;mostrarConfirmPasswordReset=!1;form=this.fb.group({empleado_id:[null,p.required],email:["",[p.required,p.email]],password:["",[p.required,p.minLength(6)]],rol:["operador_patio",p.required]});resetForm=this.fb.group({password:["",[p.required,p.minLength(6)]],confirmPassword:["",[p.required]]});ngOnInit(){if(!P(this.platformId)){this.loading=!1;return}this.cargarDatos()}retornar(){P(this.platformId)&&window.history.back()}get empleadosDisponibles(){return this.empleados.filter(n=>!n.usuario_id)}get passwordsNoCoinciden(){let n=String(this.resetForm.value.password||""),e=String(this.resetForm.value.confirmPassword||"");return e?n!==e:!1}cargarDatos(){this.loading=!0,this.usuariosService.getEmpleadosParaVincular().subscribe({next:n=>{this.empleados=n,this.usuariosService.getUsuarios().subscribe({next:e=>{this.usuarios=e,this.rolEditadoPorUsuario={};for(let i of this.usuarios)this.rolEditadoPorUsuario[i.id]=i.rol;this.loading=!1},error:e=>{this.loading=!1,this.toast.error(e?.error?.error||"No se pudo cargar la lista de usuarios")}})},error:n=>{this.loading=!1,this.toast.error(n?.error?.error||"No se pudo cargar la lista de empleados")}})}crearUsuario(){if(this.form.invalid){this.form.markAllAsTouched();return}let n=this.form.getRawValue(),e={empleado_id:Number(n.empleado_id),email:String(n.email).trim().toLowerCase(),password:String(n.password),rol:String(n.rol).trim().toLowerCase()};this.guardando=!0,this.usuariosService.crearUsuario(e).subscribe({next:()=>{this.guardando=!1,this.toast.success("Usuario creado correctamente"),this.form.patchValue({empleado_id:null,email:"",password:"",rol:"operador_patio"}),this.cargarDatos()},error:i=>{this.guardando=!1,this.toast.error(i?.error?.error||"No se pudo crear el usuario")}})}actualizarRol(n){let e=String(this.rolEditadoPorUsuario[n.id]||"").trim().toLowerCase();if(!e){this.toast.warning("Debes seleccionar un rol valido");return}if(e===String(n.rol||"").toLowerCase()){this.toast.info("No hay cambios en el rol");return}this.actualizandoRolId=n.id,this.usuariosService.actualizarRol(n.id,e).subscribe({next:()=>{this.actualizandoRolId=null,this.toast.success("Rol actualizado correctamente"),this.cargarDatos()},error:i=>{this.actualizandoRolId=null,this.toast.error(i?.error?.error||"No se pudo actualizar el rol")}})}abrirModalResetPassword(n){this.usuarioResetObjetivo=n,this.modalResetAbierto=!0,this.mostrarPasswordReset=!1,this.mostrarConfirmPasswordReset=!1,this.resetForm.reset({password:"",confirmPassword:""})}cerrarModalResetPassword(){this.reseteandoPasswordId===null&&(this.modalResetAbierto=!1,this.usuarioResetObjetivo=null,this.mostrarPasswordReset=!1,this.mostrarConfirmPasswordReset=!1,this.resetForm.reset({password:"",confirmPassword:""}))}toggleMostrarPasswordReset(){this.mostrarPasswordReset=!this.mostrarPasswordReset}toggleMostrarConfirmPasswordReset(){this.mostrarConfirmPasswordReset=!this.mostrarConfirmPasswordReset}confirmarResetPassword(){if(!this.usuarioResetObjetivo)return;if(this.resetForm.invalid){this.resetForm.markAllAsTouched();return}let n=String(this.resetForm.value.password||"").trim(),e=String(this.resetForm.value.confirmPassword||"").trim();if(n!==e){this.toast.warning("Las contrasenas no coinciden");return}this.reseteandoPasswordId=this.usuarioResetObjetivo.id,this.usuariosService.resetPassword(this.usuarioResetObjetivo.id,n).subscribe({next:()=>{this.reseteandoPasswordId=null,this.toast.success("Contrasena restablecida correctamente"),this.cerrarModalResetPassword()},error:i=>{this.reseteandoPasswordId=null,this.toast.error(i?.error?.error||"No se pudo restablecer la contrasena")}})}static \u0275fac=function(e){return new(e||s)};static \u0275cmp=M({type:s,selectors:[["app-usuarios"]],standalone:!0,features:[I],decls:51,vars:10,consts:[[1,"page"],[1,"page-header"],[1,"page-header-left"],["type","button",1,"btn-retorno",3,"click"],[1,"panel"],[1,"form-grid",3,"ngSubmit","formGroup"],[1,"field"],["formControlName","empleado_id"],["disabled","",3,"ngValue"],[3,"ngValue",4,"ngFor","ngForOf"],[4,"ngIf"],["type","email","formControlName","email","placeholder","usuario@empresa.com"],["type","password","formControlName","password","placeholder","Minimo 6 caracteres"],["formControlName","rol"],["value","admin"],["value","gerente"],["value","rrhh"],["value","operador_patio"],["value","operador"],[1,"actions"],["type","submit",1,"primary",3,"disabled"],["class","table-wrapper",4,"ngIf"],["class","modal-overlay",4,"ngIf"],[3,"ngValue"],[1,"table-wrapper"],[4,"ngFor","ngForOf"],[1,"role-select",3,"ngModelChange","ngModel","ngModelOptions"],[3,"value",4,"ngFor","ngForOf"],[1,"acciones-grid"],["type","button",1,"secondary",3,"click","disabled"],["type","button",1,"btn-reset",3,"click","disabled"],[3,"value"],[1,"modal-overlay"],["role","dialog","aria-modal","true","aria-labelledby","resetPasswordTitle",1,"modal-card"],["id","resetPasswordTitle"],[1,"modal-user"],[1,"modal-form",3,"ngSubmit","formGroup"],[1,"password-input"],["formControlName","password","placeholder","Minimo 6 caracteres",3,"type"],["type","button",1,"toggle-password",3,"click","disabled"],["class","error",4,"ngIf"],["formControlName","confirmPassword","placeholder","Repite la contrasena",3,"type"],[1,"modal-actions"],["type","submit",1,"btn-reset",3,"disabled"],[1,"error"]],template:function(e,i){e&1&&(r(0,"div",0)(1,"div",1)(2,"div",2)(3,"button",3),u("click",function(){return i.retornar()}),o(4," Retornar "),t(),r(5,"h2"),o(6,"Gestion de usuarios"),t()()(),r(7,"div",4)(8,"h3"),o(9,"Crear usuario"),t(),r(10,"form",5),u("ngSubmit",function(){return i.crearUsuario()}),r(11,"div",6)(12,"label"),o(13,"Empleado"),t(),r(14,"select",7)(15,"option",8),o(16,"Selecciona un empleado"),t(),c(17,X,2,3,"option",9),t(),c(18,Z,2,0,"small",10),t(),r(19,"div",6)(20,"label"),o(21,"Email de acceso"),t(),v(22,"input",11),t(),r(23,"div",6)(24,"label"),o(25,"Contrasena"),t(),v(26,"input",12),t(),r(27,"div",6)(28,"label"),o(29,"Rol"),t(),r(30,"select",13)(31,"option",14),o(32,"admin"),t(),r(33,"option",15),o(34,"gerente"),t(),r(35,"option",16),o(36,"rrhh"),t(),r(37,"option",17),o(38,"operador_patio"),t(),r(39,"option",18),o(40,"operador"),t()()(),r(41,"div",19)(42,"button",20),o(43),t()()()(),r(44,"div",4)(45,"h3"),o(46,"Usuarios registrados"),t(),c(47,ee,2,0,"p",10)(48,oe,16,1,"div",21)(49,ne,2,0,"p",10),t()(),c(50,le,31,14,"div",22)),e&2&&(a(10),l("formGroup",i.form),a(5),l("ngValue",null),a(2),l("ngForOf",i.empleadosDisponibles),a(),l("ngIf",!i.empleadosDisponibles.length),a(24),l("disabled",i.guardando||i.form.invalid||!i.empleadosDisponibles.length),a(),_(" ",i.guardando?"Guardando...":"Crear usuario"," "),a(4),l("ngIf",i.loading),a(),l("ngIf",!i.loading&&i.usuarios.length),a(),l("ngIf",!i.loading&&!i.usuarios.length),a(),l("ngIf",i.modalResetAbierto))},dependencies:[N,k,F,Y,j,q,$,V,L,z,T,A,G,W,D],styles:[".page[_ngcontent-%COMP%]{background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow-sm);padding:1.12rem}.page-header[_ngcontent-%COMP%]{margin-bottom:.95rem}.page-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:1.52rem}.page-header-left[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.65rem}.btn-retorno[_ngcontent-%COMP%]{border:1px solid #2d2d2d;background:#fff;color:#1a1a1a;border-radius:9px;padding:.42rem .75rem;font-size:.81rem;font-weight:700;cursor:pointer}.btn-retorno[_ngcontent-%COMP%]:hover{background:#f2f2ed}.panel[_ngcontent-%COMP%]{border:1px solid var(--border);border-radius:14px;padding:.95rem;margin-bottom:1rem;background:linear-gradient(180deg,#fff,#fbfbf7)}.panel[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin-top:0;margin-bottom:.84rem;font-size:1.07rem}.form-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.8rem}.field[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.28rem}.field[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{font-size:.8rem;color:var(--text-soft);font-weight:600}input[_ngcontent-%COMP%], select[_ngcontent-%COMP%]{padding:.52rem .62rem;border:1px solid var(--border);border-radius:10px;font-size:.88rem;background:#fff}input[_ngcontent-%COMP%]:focus, select[_ngcontent-%COMP%]:focus{outline:none;border-color:#a69000;box-shadow:0 0 0 3px #f7db2138}small[_ngcontent-%COMP%]{font-size:.75rem;color:var(--text-soft)}.error[_ngcontent-%COMP%]{color:#b42318;font-weight:600}.actions[_ngcontent-%COMP%]{display:flex;align-items:end}.primary[_ngcontent-%COMP%]{background:linear-gradient(135deg,var(--brand-yellow) 0%,var(--brand-yellow-strong) 100%);color:#191919;border:none;padding:.55rem .95rem;border-radius:10px;cursor:pointer;font-size:.86rem;font-weight:700}.primary[_ngcontent-%COMP%]:hover:not(:disabled){box-shadow:0 10px 16px #11111126}.primary[_ngcontent-%COMP%]:disabled{opacity:.62;cursor:not-allowed}.table-wrapper[_ngcontent-%COMP%]{overflow-x:auto;border:1px solid var(--border);border-radius:12px}table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse;font-size:.88rem}table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{text-align:left;background:#1f1f1f;color:#f6f6f6;padding:.65rem;border-bottom:1px solid #333;font-weight:600}table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:.64rem;border-bottom:1px solid #ebebe3;vertical-align:middle}table[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]:hover{background:#fffde8}.role-select[_ngcontent-%COMP%]{min-width:160px}.acciones-grid[_ngcontent-%COMP%]{display:flex;gap:.5rem;flex-wrap:wrap}.secondary[_ngcontent-%COMP%]{background:#ebebe3;color:#1f1f1f;border:1px solid #d8d8cf;padding:.44rem .78rem;border-radius:9px;cursor:pointer;font-size:.8rem;font-weight:600}.secondary[_ngcontent-%COMP%]:hover{background:#e2e2d8}.btn-reset[_ngcontent-%COMP%]{background:#1f1f1f;color:#fff;border:1px solid #1f1f1f;padding:.44rem .78rem;border-radius:9px;cursor:pointer;font-size:.8rem;font-weight:600}.btn-reset[_ngcontent-%COMP%]:hover{background:#000}.secondary[_ngcontent-%COMP%]:disabled, .btn-reset[_ngcontent-%COMP%]:disabled{opacity:.62;cursor:not-allowed}.password-input[_ngcontent-%COMP%]{position:relative}.password-input[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{width:100%;padding-right:5.2rem}.toggle-password[_ngcontent-%COMP%]{position:absolute;right:.42rem;top:50%;transform:translateY(-50%);border:1px solid #d8d8cf;background:#f5f5ef;color:#1f1f1f;border-radius:8px;padding:.2rem .48rem;font-size:.74rem;font-weight:700;cursor:pointer}.toggle-password[_ngcontent-%COMP%]:hover{background:#ececdf}.toggle-password[_ngcontent-%COMP%]:disabled{opacity:.62;cursor:not-allowed}.modal-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;background:#0808087a;display:grid;place-items:center;padding:1rem;z-index:1100}.modal-card[_ngcontent-%COMP%]{width:min(100%,430px);background:#fff;border-radius:14px;border:1px solid var(--border);box-shadow:0 26px 54px #00000040;padding:1rem}.modal-card[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin:0 0 .45rem;font-size:1.04rem}.modal-user[_ngcontent-%COMP%]{margin-top:0;margin-bottom:.85rem;color:var(--text-soft);font-size:.86rem}.modal-form[_ngcontent-%COMP%]{display:grid;gap:.65rem}.modal-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:.5rem;margin-top:.3rem}.capitalize[_ngcontent-%COMP%]{text-transform:capitalize}@media (max-width: 760px){.page[_ngcontent-%COMP%]{padding:.82rem}.modal-actions[_ngcontent-%COMP%]{justify-content:stretch}.modal-actions[_ngcontent-%COMP%]   .secondary[_ngcontent-%COMP%], .modal-actions[_ngcontent-%COMP%]   .btn-reset[_ngcontent-%COMP%]{flex:1}}"]})};export{K as UsuariosComponent};
